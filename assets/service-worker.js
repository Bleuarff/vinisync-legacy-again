CACHE_NAME = 'assets-20170312'

urlsToCache = [
  '/',
  '/elements/vni-app/vni-app.html',
  '/elements/vni-app/vni-app.js',
  '/elements/vni-home/vni-home.html',
  '/elements/vni-home/vni-home.js',
  '/elements/vni-cave/vni-cave.html',
  '/elements/vni-cave/vni-cave.js',
  '/elements/vni-entry/vni-entry.html',
  '/elements/vni-entry/vni-entry.js',
  '/elements/vni-main-menu/vni-main-menu.html',
  '/elements/vni-main-menu/vni-main-menu.js',
  '/elements/vni-cepages/vni-cepages.html',
  '/elements/vni-cepages/vni-cepages.js',
  '/elements/vni-filters/vni-filters.html',
  '/elements/vni-filters/vni-filters.js',
  '/elements/vni-color/vni-color.html',
  '/elements/vni-color/vni-color.js',
  '/elements/vni-z401/vni-z401.html',
  '/elements/vni-z404/vni-z404.html',
  '/img/vinisync-logo.svg',
  '/styles/shared-styles.html',
  '/bower_components/webcomponentsjs/webcomponents-lite.js',
  '/bower_components/polymer/polymer.html',
  '/bower_components/paper-toolbar/paper-toolbar.html',
  '/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html',
  '/bower_components/iron-icons/iron-icons.html',
  '/bower_components/paper-icon-button/paper-icon-button.html',
  '/bower_components/google-signin/google-signin-aware.html',
  '/bower_components/iron-pages/iron-pages.html',
  '/bower_components/paper-toast/paper-toast.html',
  '/bower_components/app-route/app-route.html',
  '/bower_components/app-route/app-location.html',
  '/bower_components/polymer/polymer-mini.html',
  '/bower_components/paper-styles/default-theme.html',
  '/bower_components/paper-styles/typography.html',
  '/bower_components/iron-flex-layout/iron-flex-layout.html',
  '/bower_components/iron-resizable-behavior/iron-resizable-behavior.html',
  '/bower_components/iron-icon/iron-icon.html',
  '/bower_components/iron-iconset-svg/iron-iconset-svg.html',
  '/bower_components/paper-behaviors/paper-inky-focus-behavior.html',
  '/bower_components/google-apis/google-js-api.html',
  '/bower_components/iron-selector/iron-selectable.html',
  '/bower_components/iron-a11y-announcer/iron-a11y-announcer.html',
  '/bower_components/iron-overlay-behavior/iron-overlay-behavior.html',
  '/bower_components/iron-location/iron-location.html',
  '/bower_components/iron-location/iron-query-params.html',
  '/bower_components/app-route/app-route-converter-behavior.html',
  '/bower_components/paper-menu/paper-menu.html',
  '/bower_components/paper-item/paper-item.html',
  '/bower_components/neon-animation/neon-animation-runner-behavior.html',
  '/bower_components/neon-animation/animations/slide-left-animation.html',
  '/bower_components/neon-animation/animations/slide-from-left-animation.html',
  '/bower_components/polymer/polymer-micro.html',
  '/bower_components/paper-styles/color.html',
  '/bower_components/font-roboto/roboto.html',
  '/bower_components/iron-meta/iron-meta.html',
  '/bower_components/iron-behaviors/iron-button-state.html',
  '/bower_components/paper-behaviors/paper-ripple-behavior.html',
  '/bower_components/iron-jsonp-library/iron-jsonp-library.html',
  '/bower_components/iron-selector/iron-selection.html',
  '/bower_components/iron-fit-behavior/iron-fit-behavior.html',
  '/bower_components/iron-overlay-behavior/iron-overlay-manager.html',
  '/bower_components/iron-overlay-behavior/iron-focusables-helper.html',
  '/bower_components/iron-menu-behavior/iron-menu-behavior.html',
  '/bower_components/paper-menu/paper-menu-shared-styles.html',
  '/bower_components/paper-item/paper-item-behavior.html',
  '/bower_components/paper-item/paper-item-shared-styles.html',
  '/bower_components/neon-animation/neon-animatable-behavior.html',
  '/bower_components/neon-animation/neon-animation-behavior.html',
  '/bower_components/neon-animation/web-animations.html',
  '/bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html',
  '/bower_components/iron-behaviors/iron-control-state.html',
  '/bower_components/paper-ripple/paper-ripple.html',
  '/bower_components/iron-overlay-behavior/iron-overlay-backdrop.html',
  '/bower_components/iron-selector/iron-multi-selectable.html',
  '/bower_components/web-animations-js/web-animations-next-lite.min.js',
  '/bower_components/google-signin/google-signin.html',
  '/bower_components/paper-button/paper-button.html',
  '/bower_components/paper-material/paper-material.html',
  '/bower_components/iron-flex-layout/iron-flex-layout-classes.html',
  '/bower_components/google-signin/google-icons.html',
  '/bower_components/google-signin/google-signin.css',
  '/bower_components/paper-behaviors/paper-button-behavior.html',
  '/bower_components/paper-material/paper-material-shared-styles.html',
  '/bower_components/paper-styles/shadow.html',
  '/bower_components/paper-fab/paper-fab.html',
  '/bower_components/paper-spinner/paper-spinner-lite.html',
  '/bower_components/iron-collapse/iron-collapse.html',
  '/bower_components/paper-spinner/paper-spinner-behavior.html',
  '/bower_components/paper-spinner/paper-spinner-styles.html',
  '/bower_components/paper-input/paper-input.html',
  '/bower_components/vaadin-combo-box/vaadin-combo-box.html',
  '/bower_components/iron-form-element-behavior/iron-form-element-behavior.html',
  '/bower_components/iron-input/iron-input.html',
  '/bower_components/paper-input/paper-input-behavior.html',
  '/bower_components/paper-input/paper-input-char-counter.html',
  '/bower_components/paper-input/paper-input-container.html',
  '/bower_components/paper-input/paper-input-error.html',
  '/bower_components/iron-validatable-behavior/iron-validatable-behavior.html',
  '/bower_components/vaadin-combo-box/vaadin-combo-box-behavior.html',
  '/bower_components/vaadin-combo-box/vaadin-combo-box-overlay.html',
  '/bower_components/vaadin-combo-box/vaadin-combo-box-shared-styles.html',
  '/bower_components/vaadin-combo-box/vaadin-combo-box-icons.html',
  '/bower_components/paper-input/paper-input-addon-behavior.html',
  '/bower_components/vaadin-combo-box/vaadin-dropdown-behavior.html',
  '/bower_components/iron-list/iron-list.html',
  '/bower_components/vaadin-combo-box/vaadin-overlay-behavior.html',
  '/bower_components/iron-scroll-target-behavior/iron-scroll-target-behavior.html',
  'https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,500italic,700,700italic',
  'https://fonts.googleapis.com/css?family=Roboto+Mono:400,700',
  'https://fonts.gstatic.com/s/roboto/v15/CWB0XYA8bzo0kSThX0UTuA.woff2',
  'https://fonts.gstatic.com/s/roboto/v15/d-6IYplOFocCacKzxwXSOFtXRa8TVwTICgirnJhmVJw.woff2'
]

// install: set up cache
self.addEventListener('install', (event) => {
  console.log('installing...')
  return event.waitUntil(
    caches.open(CACHE_NAME)
    .then((cache) => {
      return cache.addAll(urlsToCache)
    })
    .then(() => {
      console.log(`update ${CACHE_NAME}`)
      return Promise.resolve()
    })
    .catch((err) => {
      console.log('Install error: ' + err)
    })
  )
})

// activate: remove all other caches except current one
self.addEventListener('activate', (event) => {
  console.log('remove old caches')
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheName !== CACHE_NAME)
            return caches.delete(cacheName)
        })
      )
    })
    .catch((err) => {
      console.log('Activate error: ' + err)
    })
  )
})

// Handle all fetch requests
self.addEventListener('fetch', (e) => {

  // data requests: network or cache strategy
  if (e.request.url.indexOf('/api/') >= 0){
    return e.respondWith(getData(e.request))
  }

  //  asset requests: cache or network strategy
  e.respondWith(getAsset(e.request))
})

// Retrieve data: send network request. After a delay, query the cache.
// Resolves with the first that completes: network request or cache hit.
// On cache miss, do not resolve and wait for network
function getData(request){
  return new Promise((resolve, reject) => {
    // network request
    fetch(request).then((response) => {
      clearTimeout(timeoutId)
      updateCache(request, response)
      return resolve(response)
    })

    var timeoutId = setTimeout(() => {
      // cache query
      caches.open(CACHE_NAME).then((cache) => {
        return cache.match(request)
      })
      .then((cachedResponse) => {
        if (cachedResponse)
          return resolve(cachedResponse)
        console.log(`MISS ${request.url}`)
      })
    }, 400)
  })
}

// Retrieve an asset file, cache or network strategy
function getAsset(request){
  return caches.open(CACHE_NAME).then((cache) => {
    return cache.match(request)
  })
  .then((cachedResponse) => {
    if (cachedResponse){
      // console.log(`found ${request.url}`)
      return cachedResponse
    }
    console.log(`MISS ${request.url}`)
    return fetch(request).then((response) => {
      updateCache(request, response)
      return response
    })
  })
}

// add response to cache
function updateCache(request, response) {
  if (request.method !== 'GET')
    return

  var resCopy = response.clone()
  caches.open(CACHE_NAME).then((cache)=>{
    cache.put(request, resCopy)
  })
  .then(() => {
    console.log(`cached ${request.url}`)
  })
}
